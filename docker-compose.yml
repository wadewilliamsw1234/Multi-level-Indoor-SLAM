version: '3.8'

# SLAM Benchmark Docker Compose
# =============================
# Run individual algorithms or the complete benchmark pipeline.
#
# Usage:
#   docker-compose build                    # Build all images
#   docker-compose run --rm lego-loam       # Run LeGO-LOAM
#   docker-compose run --rm orb-slam3       # Run ORB-SLAM3
#   docker-compose run --rm droid-slam      # Run DROID-SLAM (requires GPU)
#
# Author: Wade Williams
# Course: EECE5554 Robotic Sensing and Navigation

services:
  # ==========================================================================
  # Base Images
  # ==========================================================================

  ros-base:
    build:
      context: .
      dockerfile: docker/Dockerfile.ros-base
    image: slam-benchmark/ros-base:latest
    volumes:
      - ${DATASET_DIR:-/home/wadewilliams/Dev/shared/datasets/ISEC}:/data:ro
      - ./results:/results
      - ./config:/config:ro
      - ./scripts:/scripts:ro
    environment:
      - ROS_MASTER_URI=http://localhost:11311
    stdin_open: true
    tty: true

  # ==========================================================================
  # SLAM Algorithms
  # ==========================================================================

  # LeGO-LOAM: LiDAR odometry (pseudo ground-truth)
  lego-loam:
    build:
      context: .
      dockerfile: docker/Dockerfile.lego-loam
    image: slam-benchmark/lego-loam:latest
    volumes:
      - ${DATASET_DIR:-/home/wadewilliams/Dev/shared/datasets/ISEC}:/data:ro
      - ./results:/results
      - ./config/lego_loam:/config:ro
    environment:
      - ROS_MASTER_URI=http://localhost:11311
    stdin_open: true
    tty: true

  # ORB-SLAM3: Feature-based stereo SLAM
  orb-slam3:
    build:
      context: .
      dockerfile: docker/Dockerfile.orb-slam3
    image: slam-benchmark/orb-slam3:latest
    volumes:
      - ${DATASET_DIR:-/home/wadewilliams/Dev/shared/datasets/ISEC}:/data:ro
      - ./results:/results
      - ./config/orb_slam3:/config:ro
    stdin_open: true
    tty: true

  # DROID-SLAM: Deep learning stereo SLAM (requires GPU)
  droid-slam:
    build:
      context: .
      dockerfile: docker/Dockerfile.droid-slam
    image: slam-benchmark/droid-slam:latest
    runtime: nvidia
    environment:
      - NVIDIA_VISIBLE_DEVICES=all
      - NVIDIA_DRIVER_CAPABILITIES=compute,utility
    volumes:
      - ${DATASET_DIR:-/home/wadewilliams/Dev/shared/datasets/ISEC}:/data:ro
      - ./results:/results
      - ./config:/config:ro
      - ./scripts/droid_slam:/scripts:ro
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]
    stdin_open: true
    tty: true

  # Basalt: Visual-inertial odometry
  basalt:
    build:
      context: .
      dockerfile: docker/Dockerfile.basalt
    image: slam-benchmark/basalt:latest
    volumes:
      - ${DATASET_DIR:-/home/wadewilliams/Dev/shared/datasets/ISEC}:/data:ro
      - ./results:/results
      - ./config/basalt:/config:ro
    stdin_open: true
    tty: true

  # VINS-Fusion: Visual-inertial SLAM
  vins-fusion:
    build:
      context: .
      dockerfile: docker/Dockerfile.vins-fusion
    image: slam-benchmark/vins-fusion:latest
    volumes:
      - ${DATASET_DIR:-/home/wadewilliams/Dev/shared/datasets/ISEC}:/data:ro
      - ./results:/results
      - ./config/vins_fusion:/config:ro
    environment:
      - ROS_MASTER_URI=http://localhost:11311
    stdin_open: true
    tty: true

  # Kimera-VIO: MIT SPARK Lab visual-inertial odometry
  kimera:
    build:
      context: .
      dockerfile: docker/Dockerfile.kimera
    image: slam-benchmark/kimera:latest
    volumes:
      - ${DATASET_DIR:-/home/wadewilliams/Dev/shared/datasets/ISEC}:/data:ro
      - ./results:/results
      - ./config/kimera:/config:ro
    environment:
      - ROS_MASTER_URI=http://localhost:11311
    stdin_open: true
    tty: true

  # ==========================================================================
  # Semantic SLAM Algorithms
  # ==========================================================================

  # SuMa++: Semantic LiDAR SLAM (PRBonn)
  suma-plus-plus:
    build:
      context: .
      dockerfile: docker/Dockerfile.suma-plus-plus
    image: slam-benchmark/suma-plus-plus:latest
    runtime: nvidia
    environment:
      - NVIDIA_VISIBLE_DEVICES=all
      - NVIDIA_DRIVER_CAPABILITIES=compute,utility
      - ROS_MASTER_URI=http://localhost:11311
    volumes:
      - ${DATASET_DIR:-/home/wadewilliams/Dev/shared/datasets/ISEC}:/data:ro
      - ./results:/results
      - ./config/suma_plus_plus:/config:ro
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]
    stdin_open: true
    tty: true

  # YOLOv8-ORB-SLAM3: ORB-SLAM3 with dynamic object filtering
  yolo-orb-slam3:
    build:
      context: .
      dockerfile: docker/Dockerfile.yolo-orb-slam3
    image: slam-benchmark/yolo-orb-slam3:latest
    runtime: nvidia
    environment:
      - NVIDIA_VISIBLE_DEVICES=all
      - NVIDIA_DRIVER_CAPABILITIES=compute,utility
      - ROS_MASTER_URI=http://localhost:11311
    volumes:
      - ${DATASET_DIR:-/home/wadewilliams/Dev/shared/datasets/ISEC}:/data:ro
      - ./results:/results
      - ./config/orb_slam3:/config:ro
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]
    stdin_open: true
    tty: true

  # S-Graphs 2.0: Hierarchical SLAM with Floor-Level Constraints
  # The ONLY algorithm specifically designed for multi-floor SLAM
  s-graphs:
    build:
      context: .
      dockerfile: docker/Dockerfile.s-graphs
    image: slam-benchmark/s-graphs:latest
    volumes:
      - ${DATASET_DIR:-/home/wadewilliams/Dev/shared/datasets/ISEC}:/data:ro
      - ./results:/results
      - ./config/s_graphs:/config:ro
    environment:
      - ROS_MASTER_URI=http://localhost:11311
    stdin_open: true
    tty: true

  # ==========================================================================
  # Semantic Tools and Post-Processing
  # ==========================================================================

  # Semantic Tools: Foundation model VPR, geometric verification, evaluation
  semantic-tools:
    build:
      context: .
      dockerfile: docker/Dockerfile.semantic-tools
    image: slam-benchmark/semantic-tools:latest
    runtime: nvidia
    environment:
      - NVIDIA_VISIBLE_DEVICES=all
      - NVIDIA_DRIVER_CAPABILITIES=compute,utility
    volumes:
      - ${DATASET_DIR:-/home/wadewilliams/Dev/shared/datasets/ISEC}:/data:ro
      - ./results:/results
      - ./scripts/semantic_gating:/scripts/semantic_gating:ro
      - ./scripts/evaluation:/scripts/evaluation:ro
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]
    shm_size: '8gb'
    stdin_open: true
    tty: true

networks:
  default:
    name: slam-benchmark-network
