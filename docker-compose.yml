version: '3.8'

services:
  # ROS base image with bag playback utilities
  ros-base:
    build:
      context: .
      dockerfile: docker/Dockerfile.ros-base
    image: slam-benchmark/ros-base:latest
    volumes:
      - /home/wadewilliams/Dev/shared/datasets/ISEC:/data/ISEC:ro
      - ./results:/results
      - ./config:/config
      - ./scripts:/scripts:ro
    environment:
      - ROS_MASTER_URI=http://localhost:11311
    stdin_open: true
    tty: true

  # ORB-SLAM3: Feature-based stereo SLAM
  orb-slam3:
    build:
      context: .
      dockerfile: docker/Dockerfile.orb-slam3
    image: slam-benchmark/orb-slam3:latest
    depends_on:
      - ros-base
    volumes:
      - /home/wadewilliams/Dev/shared/datasets/ISEC:/data/ISEC:ro
      - ./results:/results
      - ./config:/config
      - ./scripts:/scripts:ro
    environment:
      - ROS_MASTER_URI=http://localhost:11311
    command: >
      bash -c "source /opt/ros/noetic/setup.bash && 
               python3 /scripts/run_algorithm.py --algorithm orb-slam3 --all-sequences"

  # VINS-Fusion: Visual-inertial SLAM
  vins-fusion:
    build:
      context: .
      dockerfile: docker/Dockerfile.vins-fusion
    image: slam-benchmark/vins-fusion:latest
    depends_on:
      - ros-base
    volumes:
      - /home/wadewilliams/Dev/shared/datasets/ISEC:/data/ISEC:ro
      - ./results:/results
      - ./config:/config
      - ./scripts:/scripts:ro
    environment:
      - ROS_MASTER_URI=http://localhost:11311
    command: >
      bash -c "source /opt/ros/noetic/setup.bash &&
               source /catkin_ws/devel/setup.bash &&
               python3 /scripts/run_algorithm.py --algorithm vins-fusion --all-sequences"

  # Basalt: Visual-inertial SLAM with loop closure analysis
  basalt:
    build:
      context: .
      dockerfile: docker/Dockerfile.basalt
    image: slam-benchmark/basalt:latest
    depends_on:
      - ros-base
    volumes:
      - /home/wadewilliams/Dev/shared/datasets/ISEC:/data/ISEC:ro
      - ./results:/results
      - ./config:/config
      - ./scripts:/scripts:ro
    command: >
      python3 /scripts/run_algorithm.py --algorithm basalt --all-sequences

  # DROID-SLAM: Deep learning-based SLAM (requires GPU)
  droid-slam:
    build:
      context: .
      dockerfile: docker/Dockerfile.droid-slam
    image: slam-benchmark/droid-slam:latest
    runtime: nvidia
    environment:
      - NVIDIA_VISIBLE_DEVICES=all
      - NVIDIA_DRIVER_CAPABILITIES=compute,utility
    depends_on:
      - ros-base
    volumes:
      - /home/wadewilliams/Dev/shared/datasets/ISEC:/data/ISEC:ro
      - ./results:/results
      - ./config:/config
      - ./scripts:/scripts:ro
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]
    command: >
      python3 /scripts/run_algorithm.py --algorithm droid-slam --all-sequences

  # LeGO-LOAM: LiDAR SLAM (used as pseudo ground-truth)
  lego-loam:
    build:
      context: .
      dockerfile: docker/Dockerfile.lego-loam
    image: slam-benchmark/lego-loam:latest
    depends_on:
      - ros-base
    volumes:
      - /home/wadewilliams/Dev/shared/datasets/ISEC:/data/ISEC:ro
      - ./results:/results
      - ./config:/config
      - ./scripts:/scripts:ro
    environment:
      - ROS_MASTER_URI=http://localhost:11311
    command: >
      bash -c "source /opt/ros/noetic/setup.bash &&
               source /catkin_ws/devel/setup.bash &&
               python3 /scripts/run_algorithm.py --algorithm lego-loam --all-sequences"

  # Evaluation service: Compute metrics and generate figures
  evaluation:
    build:
      context: .
      dockerfile: docker/Dockerfile.evaluation
    image: slam-benchmark/evaluation:latest
    volumes:
      - ./results:/results
      - ./config:/config
      - ./scripts:/scripts:ro
    command: python3 /scripts/evaluate.py --all

  # Main benchmark runner (runs all algorithms sequentially)
  slam-benchmark:
    build:
      context: .
      dockerfile: docker/Dockerfile.ros-base
    image: slam-benchmark/ros-base:latest
    volumes:
      - /home/wadewilliams/Dev/shared/datasets/ISEC:/data/ISEC:ro
      - ./results:/results
      - ./config:/config
      - ./scripts:/scripts:ro
      - /var/run/docker.sock:/var/run/docker.sock
    command: >
      bash -c "echo 'Starting SLAM Benchmark Pipeline...' &&
               echo 'Step 1: Running LeGO-LOAM for pseudo ground-truth...' &&
               echo 'Step 2: Running ORB-SLAM3...' &&
               echo 'Step 3: Running VINS-Fusion...' &&
               echo 'Step 4: Running Basalt...' &&
               echo 'Step 5: Running DROID-SLAM...' &&
               echo 'Step 6: Running evaluation...' &&
               python3 /scripts/run_benchmark.py"

networks:
  default:
    name: slam-benchmark-network
